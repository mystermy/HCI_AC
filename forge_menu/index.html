<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sword Forge Pomodoro</title>
<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #111;
        color: #fff;
        text-align: center;
    }
    #menuBar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: #222;
        padding: 10px;
        display: flex;
        gap: 10px;
        z-index: 10;
    }
    #content { padding-top: 60px; }
    button { padding: 8px 12px; }
    .hidden { display: none; }
    #timer { font-size: 3em; margin: 20px 0; }
    #forgeArea { font-size: 2em; margin-top: 40px; }
</style>
</head>
<body>
    <div id="menuBar">
        <button id="viewBladesBtn">View Forged Blades</button>
        <button id="forgeNewBtn">Forge New Blade</button>
    </div>
    <div id="content">
        <div id="mainMenu">
            <h1>Sword Forge</h1>
            <p>Select an option above to begin.</p>
        </div>
        <div id="bladeList" class="hidden">
            <h2>Forged Blades</h2>
            <ul id="blades"></ul>
            <button class="backBtn">Back to Menu</button>
        </div>
        <div id="setupView" class="hidden">
            <h2>Forge Setup</h2>
            <div>
                <label>Work Duration (min) <input type="number" id="workInput" value="25" min="1"></label>
            </div>
            <div>
                <label>Number of Cycles <input type="number" id="cycleInput" value="1" min="1"></label>
            </div>
            <div>
                <label>Break Duration (min) <input type="number" id="breakInput" value="5" min="1"></label>
            </div>
            <button id="beginBtn">Begin Forging</button>
            <button class="backBtn">Back to Menu</button>
        </div>
        <div id="forgeSession" class="hidden">
            <div id="forgeArea"></div>
            <div id="timer">00:00</div>
            <button id="reenterBtn" class="hidden">Re-enter Forge</button>
        </div>
        <div id="summaryView" class="hidden">
            <h2>Session Summary</h2>
            <p id="summaryText"></p>
            <div id="nameBlock" class="hidden">
                <input type="text" id="bladeName" placeholder="Blade Name">
                <button id="saveBladeBtn">Save Blade</button>
            </div>
            <button class="backBtn">Back to Menu</button>
        </div>
    </div>
<script>
// MENU SETUP
const viewBtn = document.getElementById('viewBladesBtn');
const forgeBtn = document.getElementById('forgeNewBtn');
const mainMenu = document.getElementById('mainMenu');
const bladeListView = document.getElementById('bladeList');
const setupView = document.getElementById('setupView');
const sessionView = document.getElementById('forgeSession');
const summaryView = document.getElementById('summaryView');
const backBtns = document.querySelectorAll('.backBtn');
const bladesUL = document.getElementById('blades');

const workInput = document.getElementById('workInput');
const cycleInput = document.getElementById('cycleInput');
const breakInput = document.getElementById('breakInput');
const beginBtn = document.getElementById('beginBtn');
const timerDisplay = document.getElementById('timer');
const forgeArea = document.getElementById('forgeArea');
const reenterBtn = document.getElementById('reenterBtn');
const summaryText = document.getElementById('summaryText');
const nameBlock = document.getElementById('nameBlock');
const bladeNameInput = document.getElementById('bladeName');
const saveBladeBtn = document.getElementById('saveBladeBtn');

let forgedBlades = [];
let workSeconds = 0;
let breakSeconds = 0;
let cycles = 0;
let currentCycle = 0;
let state = 'idle';
let remaining = 0;
let workInterval = null;
let breakInterval = null;
let warpInterval = null;
let warpElapsed = 0;
let offWork = 0;
let offBreak = 0;
let breakStart = 0;

function show(view) {
    mainMenu.classList.add('hidden');
    bladeListView.classList.add('hidden');
    setupView.classList.add('hidden');
    sessionView.classList.add('hidden');
    summaryView.classList.add('hidden');
    view.classList.remove('hidden');
}

viewBtn.onclick = () => {
    bladesUL.innerHTML = forgedBlades.map(b => `<li>${b}</li>`).join('') || '<li>No blades yet.</li>';
    show(bladeListView);
};

forgeBtn.onclick = () => show(setupView);

backBtns.forEach(btn => btn.onclick = () => show(mainMenu));

beginBtn.onclick = () => {
    workSeconds = parseInt(workInput.value, 10) * 60;
    breakSeconds = parseInt(breakInput.value, 10) * 60;
    cycles = parseInt(cycleInput.value, 10);
    if (!workSeconds || !breakSeconds || !cycles) return;
    offWork = 0;
    offBreak = 0;
    currentCycle = 1;
    startWork();
};

saveBladeBtn.onclick = () => {
    const name = bladeNameInput.value.trim() || `Blade ${forgedBlades.length + 1}`;
    forgedBlades.push(name);
    bladeNameInput.value = '';
    show(mainMenu);
};

reenterBtn.onclick = () => {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
};

function format(sec) {
    const m = String(Math.floor(sec / 60)).padStart(2, '0');
    const s = String(sec % 60).padStart(2, '0');
    return `${m}:${s}`;
}

// FULLSCREEN HANDLERS
document.addEventListener('fullscreenchange', () => {
    if (state === 'work') {
        if (!document.fullscreenElement) {
            if (!warpInterval) {
                warpElapsed = 0;
                warpInterval = setInterval(() => {
                    warpElapsed++;
                    if (warpElapsed >= remaining) {
                        failSession();
                    }
                }, 1000);
            }
        } else {
            if (warpInterval) {
                clearInterval(warpInterval);
                offWork += warpElapsed;
                warpInterval = null;
            }
        }
    } else if (state === 'break') {
        if (document.fullscreenElement) {
            clearInterval(breakInterval);
            offBreak += Math.round((Date.now() - breakStart) / 1000);
            if (currentCycle > cycles) {
                endSession(true);
            } else {
                startWork();
            }
        }
    }
});

// TIMER LOGIC
function startWork() {
    state = 'work';
    remaining = workSeconds;
    forgeArea.textContent = `Forge Cycle ${currentCycle}`;
    reenterBtn.classList.add('hidden');
    show(sessionView);
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    timerDisplay.textContent = format(remaining);
    workInterval = setInterval(() => {
        remaining--;
        timerDisplay.textContent = format(remaining);
        if (remaining <= 0) {
            clearInterval(workInterval);
            startBreak();
        }
    }, 1000);
}

function startBreak() {
    state = 'break';
    remaining = breakSeconds;
    forgeArea.textContent = 'Break';
    reenterBtn.classList.remove('hidden');
    timerDisplay.textContent = format(remaining);
    if (document.fullscreenElement) document.exitFullscreen();
    breakStart = Date.now();
    breakInterval = setInterval(() => {
        remaining--;
        timerDisplay.textContent = format(remaining);
        if (remaining <= 0) {
            clearInterval(breakInterval);
            failSession();
        }
    }, 1000);
    currentCycle++;
}

function endSession(pass) {
    clearInterval(workInterval);
    clearInterval(breakInterval);
    clearInterval(warpInterval);
    if (document.fullscreenElement) document.exitFullscreen();
    state = 'summary';
    summaryText.innerHTML = `Outside work: ${offWork}s<br>Outside break: ${offBreak}s<br>` + (pass ? 'Blade Forged' : 'Blade Broken');
    if (pass) {
        nameBlock.classList.remove('hidden');
    } else {
        nameBlock.classList.add('hidden');
    }
    show(summaryView);
}

function failSession() {
    if (state === 'work' && warpInterval) offWork += warpElapsed;
    if (state === 'break') offBreak += Math.round((Date.now() - breakStart) / 1000);
    endSession(false);
}

</script>
</body>
</html>
